# Copied from: https://docs.github.com/en/actions/use-cases-and-examples/building-and-testing/building-and-testing-python#publishing-to-package-registries
# Better reference from: https://packaging.python.org/en/latest/guides/publishing-package-distribution-releases-using-github-actions-ci-cd-workflows/
# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.

# GitHub recommends pinning actions to a commit SHA.
# To get a newer version, you will need to update the SHA.
# You can also reference a tag or branch, but the action may change without warning.

name: Upload Python Package

on:
  # Temporarily trigger on push to test branch for testing
  push:
    branches:
      - chuang-test-pypi-build
  # Original trigger - uncomment when done testing
  # release:
  #   types: [published]

permissions:
  id-token: write  # IMPORTANT: mandatory for trusted publishing

jobs:
  build_wheels:
    name: Build wheels on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-13, macos-latest]

    steps:
    - uses: actions/checkout@v4
      with:
        persist-credentials: false
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"
    - name: Install cibuildwheel
      run: python -m pip install cibuildwheel==2.21.3
    - name: Build wheels
      run: python -m cibuildwheel --output-dir dist
      env:
        # Build for CPython 3.9-3.12
        CIBW_BUILD: cp39-* cp310-* cp311-* cp312-*
        # Skip 32-bit builds and musllinux
        CIBW_SKIP: "*-win32 *-manylinux_i686 *-musllinux_*"
        # Install gfortran before building (for manylinux)
        CIBW_BEFORE_ALL_LINUX: yum install -y gcc-gfortran || apk add gfortran
        # Install gfortran on macOS and create symlink for both architectures
        CIBW_BEFORE_ALL_MACOS: |
          brew install gcc
          # Find the actual gfortran binary and create symlink
          BREW_PREFIX=$(brew --prefix)
          for gf in ${BREW_PREFIX}/bin/gfortran-*; do
            if [ -x "$gf" ]; then
              ln -sf "$gf" ${BREW_PREFIX}/bin/gfortran
              echo "Created symlink: ${BREW_PREFIX}/bin/gfortran -> $gf"
              break
            fi
          done
          # Verify gfortran is now available
          which gfortran || echo "gfortran not found in PATH"
          ls -la ${BREW_PREFIX}/bin/gfortran* || true
        # Verify before each build that gfortran is available
        CIBW_BEFORE_BUILD_MACOS: |
          echo "PATH is: $PATH"
          which gfortran && gfortran --version || echo "gfortran not found"
        # Set environment for macOS builds - PATH must use {project} syntax for expansion
        CIBW_ENVIRONMENT_MACOS: 'PATH="/opt/homebrew/bin:/usr/local/bin:$PATH" FC=gfortran CC=clang'
    - name: Store the distribution packages
      uses: actions/upload-artifact@v4
      with:
        name: python-package-distributions-${{ matrix.os }}
        path: dist/

  build_sdist:
    name: Build source distribution
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        persist-credentials: false
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"
    - name: Install build
      run: python -m pip install build
    - name: Build sdist
      run: python -m build --sdist
    - name: Store the distribution packages
      uses: actions/upload-artifact@v4
      with:
        name: python-package-distributions-sdist
        path: dist/
  publish-to-pypi:
    name: >-
      Publish Python ğŸ distribution ğŸ“¦ to PyPI
    # Disabled for testing - will fail since there's no tag
    if: false  # startsWith(github.ref, 'refs/tags/')
    needs:
    - build_wheels
    - build_sdist
    runs-on: ubuntu-latest
    environment:
      name: pypi
      url: https://pypi.org/p/falwa
    permissions:
      id-token: write  # IMPORTANT: mandatory for trusted publishing
    steps:
    - name: Download all the dists
      uses: actions/download-artifact@v4
      with:
        pattern: python-package-distributions-*
        path: dist/
        merge-multiple: true
    - name: Publish distribution ğŸ“¦ to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
